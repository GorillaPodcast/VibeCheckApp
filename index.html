<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VibeCheck Pro | Master Director</title>
    
    <!-- PWA Meta -->
    <meta name="theme-color" content="#020617">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" id="pwa-manifest">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --bg: #020617;
            --panel: rgba(15, 23, 42, 0.7);
            --violet: #8b5cf6;
            --emerald: #10b981;
            --pink: #f472b6;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg);
            color: #f1f5f9;
            overflow-x: hidden;
        }

        .glass {
            background: var(--panel);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.8);
        }

        .neon-border-violet { border: 1px solid rgba(139, 92, 246, 0.3); }
        .neon-border-emerald { border: 1px solid rgba(16, 185, 129, 0.3); }

        .gradient-text {
            background: linear-gradient(135deg, #a78bfa 0%, #f472b6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .install-overlay {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at center, #0f172a 0%, #020617 100%);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            text-align: center;
        }

        .performance-tag {
            color: var(--pink);
            font-weight: 800;
            font-style: italic;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }

        .shimmer {
            background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite linear;
        }

        @keyframes shimmer {
            to { background-position: -200% 0; }
        }

        .ios-indicator {
            position: absolute;
            bottom: 40px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
            40% {transform: translateY(-20px);}
            60% {transform: translateY(-10px);}
        }

        /* Hide scrollbars */
        ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body>

    <!-- 1. GATEKEEPER / INSTALLATION SCREEN -->
    <div id="gatekeeper" class="install-overlay">
        <div class="w-24 h-24 bg-violet-600 rounded-3xl mb-8 flex items-center justify-center shadow-2xl shadow-violet-500/40">
            <i class="fa-solid fa-clapperboard text-5xl text-white"></i>
        </div>
        <h1 class="text-4xl font-extrabold mb-4 tracking-tighter">VibeCheck <span class="gradient-text">Pro</span></h1>
        <p class="text-slate-400 max-w-xs mb-10 leading-relaxed">Please install this app to your Home Screen to unlock the Director Engine.</p>
        
        <!-- Platform Specific Guide -->
        <div id="ios-guide" class="hidden space-y-4">
            <div class="p-6 glass rounded-2xl border border-white/10">
                <p class="text-sm font-medium mb-4">1. Tap the <i class="fa-solid fa-share-from-square text-violet-400"></i> share button</p>
                <p class="text-sm font-medium">2. Scroll down and select <br> <span class="text-white font-bold text-base mt-2 block">"Add to Home Screen"</span></p>
            </div>
            <div class="ios-indicator">
                <i class="fa-solid fa-chevron-down text-3xl text-violet-500"></i>
            </div>
        </div>

        <div id="android-guide" class="hidden">
            <button onclick="triggerAndroidInstall()" class="px-10 py-4 bg-violet-600 text-white font-black rounded-2xl shadow-xl active:scale-95 transition-all">
                INSTALL TO DEVICE
            </button>
        </div>
    </div>

    <!-- 2. SETTINGS VAULT (Hidden by default) -->
    <div id="settings-modal" class="fixed inset-0 z-[110] bg-black/90 backdrop-blur-xl hidden flex items-center justify-center p-6">
        <div class="glass w-full max-w-md p-8 rounded-3xl neon-border-violet">
            <h2 class="text-2xl font-black mb-2">Director Vault</h2>
            <p class="text-slate-400 text-sm mb-6">Your Gemini API Key is stored only on this device. We never see it.</p>
            <input type="password" id="api-key-input" class="w-full bg-slate-950 border border-white/10 rounded-xl p-4 mb-6 text-white focus:border-violet-500 outline-none" placeholder="Paste Gemini API Key...">
            <div class="flex gap-3">
                <button onclick="saveApiKey()" class="flex-grow bg-violet-600 py-4 rounded-xl font-bold">Save Key</button>
                <button onclick="toggleSettings(false)" class="px-6 bg-slate-800 py-4 rounded-xl font-bold">Close</button>
            </div>
        </div>
    </div>

    <!-- 3. MAIN APP INTERFACE -->
    <div id="main-app" class="hidden opacity-0 transition-opacity duration-1000">
        <!-- Navigation -->
        <nav class="flex justify-between items-center mb-10 p-2">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-violet-600 rounded-xl flex items-center justify-center">
                    <i class="fa-solid fa-clapperboard text-white text-xl"></i>
                </div>
                <span class="font-black text-xl tracking-tighter">VibeCheck <span class="text-violet-500">Pro</span></span>
            </div>
            <button onclick="toggleSettings(true)" class="w-12 h-12 glass rounded-full flex items-center justify-center hover:bg-white/5 transition-all">
                <i class="fa-solid fa-gear text-slate-400"></i>
            </button>
        </nav>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 pb-20">
            <!-- Sidebar: Inputs -->
            <div class="lg:col-span-4 space-y-6">
                <div class="glass p-6 rounded-[2rem] space-y-6">
                    <div>
                        <div class="flex justify-between mb-3">
                            <label class="text-[10px] uppercase font-black tracking-widest text-slate-500">Target Accent</label>
                            <span class="text-[10px] text-emerald-400 font-bold">Auto-Emotion: ON</span>
                        </div>
                        <select id="accent-selector" class="w-full bg-slate-900/50 border border-white/5 rounded-2xl p-4 font-bold text-white appearance-none cursor-pointer outline-none focus:border-violet-500 transition-all">
                            <option value="UK Roadman (MLE)">UK Roadman</option>
                            <option value="Jamaican Patois">Jamaican Patois</option>
                            <option value="Nigerian Pidgin">Nigerian Pidgin</option>
                            <option value="German-English">German Accent</option>
                            <option value="New York Bronx">NY Bronx</option>
                        </select>
                    </div>

                    <textarea id="vo-input" class="w-full h-40 bg-slate-950/50 border border-white/5 rounded-2xl p-5 text-slate-200 leading-relaxed font-medium outline-none focus:border-violet-500" placeholder="Script Dialogue..."></textarea>
                    
                    <textarea id="base-image-input" class="w-full h-24 bg-slate-950/50 border border-white/5 rounded-2xl p-5 text-sm text-slate-400 italic outline-none focus:border-violet-500" placeholder="Base Character: e.g. Silverback Gorilla in studio..."></textarea>

                    <button id="direct-btn" onclick="runDirector()" class="w-full bg-violet-600 py-5 rounded-2xl font-black text-white shadow-2xl shadow-violet-600/30 active:scale-95 transition-all flex items-center justify-center gap-3">
                        <i class="fa-solid fa-wand-magic-sparkles"></i> DIRECT PERFORMANCE
                    </button>
                </div>
            </div>

            <!-- Stage: Output -->
            <div class="lg:col-span-8">
                <div id="storyboard-stage" class="glass rounded-[2rem] min-h-[600px] flex flex-col p-8">
                    <div id="empty-state" class="flex-grow flex flex-col items-center justify-center opacity-20 py-20">
                        <i class="fa-solid fa-film text-8xl mb-6"></i>
                        <p class="font-black text-2xl uppercase tracking-widest">Stage Awaiting Instruction</p>
                    </div>

                    <div id="loading-state" class="hidden space-y-8 py-10">
                        <div class="h-32 shimmer rounded-3xl w-full"></div>
                        <div class="h-32 shimmer rounded-3xl w-full"></div>
                    </div>

                    <div id="scene-list" class="hidden space-y-12">
                        <!-- Content Injected -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // PWA Configuration
        const manifest = {
            "name": "VibeCheck Pro Director",
            "short_name": "VibeCheck",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#020617",
            "theme_color": "#020617",
            "icons": [{ "src": "https://cdn-icons-png.flaticon.com/512/3658/3658956.png", "sizes": "512x512", "type": "image/png" }]
        };
        document.getElementById('pwa-manifest').setAttribute('href', 'data:application/manifest+json,' + JSON.stringify(manifest));

        // State Management
        let deferredPrompt;
        const gatekeeper = document.getElementById('gatekeeper');
        const mainApp = document.getElementById('main-app');
        const iosGuide = document.getElementById('ios-guide');
        const androidGuide = document.getElementById('android-guide');
        const settingsModal = document.getElementById('settings-modal');
        const apiKeyInput = document.getElementById('api-key-input');

        // Check for Standalone Mode (The Gatekeeper)
        window.addEventListener('load', () => {
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
            
            if (isStandalone) {
                unlockApp();
            } else {
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                if (isIOS) iosGuide.classList.remove('hidden');
                else androidGuide.classList.remove('hidden');
            }

            // Load saved key
            const savedKey = localStorage.getItem('vibecheck_api_key');
            if (savedKey) apiKeyInput.value = savedKey;
        });

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
        });

        function triggerAndroidInstall() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') unlockApp();
                    deferredPrompt = null;
                });
            }
        }

        function unlockApp() {
            gatekeeper.style.display = 'none';
            mainApp.classList.remove('hidden');
            setTimeout(() => mainApp.style.opacity = '1', 100);
        }

        function toggleSettings(show) {
            settingsModal.classList.toggle('hidden', !show);
        }

        function saveApiKey() {
            localStorage.setItem('vibecheck_api_key', apiKeyInput.value);
            toggleSettings(false);
        }

        // --- CORE DIRECTOR LOGIC ---
        async function runDirector() {
            const key = localStorage.getItem('vibecheck_api_key');
            if (!key) { toggleSettings(true); return; }

            const vo = document.getElementById('vo-input').value.trim();
            const baseImg = document.getElementById('base-image-input').value.trim();
            const accent = document.getElementById('accent-selector').value;

            if (!vo || !baseImg) return;

            // UI Transitions
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('scene-list').classList.add('hidden');
            document.getElementById('loading-state').classList.remove('hidden');
            const btn = document.getElementById('direct-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-atom fa-spin"></i> SYNCING PERFORMANCE...';

            const systemPrompt = `You are a "Director Brain". 
            Analyze the input script. Proactively inject emotional cues (sighs, nods, frowns, laughs) to make it feel like a real podcast.
            Rewrite everything in "${accent}".
            
            Output strictly JSON:
            { "scenes": [ { "audio": "Dialect text with [Emotion] cues", "image": "Prompt for keyframe image with the specific emotion pose", "video": "Native Sync prompt including: Dialogue: '...' and motion commands." } ] }`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `SCRIPT: ${vo}\nBASE CHARACTER: ${baseImg}` }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });

                const data = await response.json();
                const result = JSON.parse(data.candidates[0].content.parts[0].text);
                renderStoryboard(result.scenes);
            } catch (err) {
                alert("Director Error: Please check your API key in settings.");
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> DIRECT PERFORMANCE';
                document.getElementById('loading-state').classList.add('hidden');
            }
        }

        function renderStoryboard(scenes) {
            const list = document.getElementById('scene-list');
            list.innerHTML = '';
            
            scenes.forEach((scene, i) => {
                const audioHtml = scene.audio.replace(/\[(.*?)\]/g, '<span class="performance-tag">[$1]</span>');
                const div = document.createElement('div');
                div.className = "p-8 glass rounded-[2.5rem] space-y-6 neon-border-emerald";
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="bg-emerald-600 text-[10px] font-black px-3 py-1 rounded-full">SCENE ${i+1}</span>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="space-y-2">
                            <label class="text-[9px] uppercase font-black text-slate-500 tracking-widest">1. Performance Audio (ElevenLabs)</label>
                            <div class="p-4 bg-slate-950/80 rounded-2xl border border-white/5 text-lg font-medium relative group">
                                ${audioHtml}
                                <button onclick="copyThis(this, '${scene.audio.replace(/'/g, "\\'")}')" class="absolute top-4 right-4 text-slate-500 hover:text-white"><i class="fa-regular fa-copy"></i></button>
                            </div>
                        </div>

                        <div class="space-y-2">
                            <label class="text-[9px] uppercase font-black text-slate-500 tracking-widest text-violet-400">2. Keyframe Image (Midjourney)</label>
                            <div class="p-4 bg-violet-950/10 rounded-2xl border border-violet-500/20 text-xs text-slate-400 relative">
                                "${scene.image}"
                                <button onclick="copyThis(this, '${scene.image.replace(/'/g, "\\'")}')" class="absolute top-4 right-4 text-slate-500 hover:text-white"><i class="fa-regular fa-copy"></i></button>
                            </div>
                        </div>

                        <div class="space-y-2">
                            <label class="text-[9px] uppercase font-black text-slate-500 tracking-widest text-emerald-400">3. Video Sync Prompt (Veo/Runway)</label>
                            <div class="p-4 bg-emerald-950/10 rounded-2xl border border-emerald-500/20 text-xs font-mono text-emerald-100/80 relative">
                                ${scene.video}
                                <button onclick="copyThis(this, '${scene.video.replace(/'/g, "\\'")}')" class="absolute top-4 right-4 text-slate-500 hover:text-white"><i class="fa-regular fa-copy"></i></button>
                            </div>
                        </div>
                    </div>
                `;
                list.appendChild(div);
            });
            list.classList.remove('hidden');
        }

        window.copyThis = (btn, text) => {
            const el = document.createElement('textarea');
            el.value = text;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            btn.innerHTML = '<i class="fa-solid fa-check text-emerald-500"></i>';
            setTimeout(() => btn.innerHTML = '<i class="fa-regular fa-copy"></i>', 2000);
        };

        // Simple SW for PWA
        if ('serviceWorker' in navigator) {
            const sw = `self.addEventListener('fetch', e => e.respondWith(fetch(e.request)));`;
            const blob = new Blob([sw], {type: 'text/javascript'});
            navigator.serviceWorker.register(URL.createObjectURL(blob));
        }
    </script>
</body>
</html>

